# Google CSE API 优化方案

## 问题
Google Custom Search Engine (CSE) API 免费版每日配额限制为 100 次查询。当配额用完后，所有搜索请求都会返回 429 错误。

## 优化措施

### 1. 增加缓存时间 ⏰
- **之前**: 缓存 10 分钟 (600 秒)
- **现在**: 
  - 普通查询: 缓存 24 小时 (86400 秒)
  - 优惠券查询: 缓存 12 小时 (43200 秒)
- **效果**: 大幅减少重复 API 调用，相同查询在 24 小时内只调用一次 API

### 2. API 配额检查 🛡️
- **新增功能**: `check_quota_exceeded()` 函数
- **机制**: 
  - 当检测到 429 错误时，在 Redis 中设置 `google_cse:quota_exceeded` 标志
  - 标志有效期 24 小时（配额每天重置）
  - 所有搜索函数在执行前都会检查此标志
- **效果**: 避免在配额用完后继续浪费 API 调用

### 3. 优化优惠券查询 📉
- **之前**: 15 个查询
- **现在**: 5 个优化后的查询
- **策略**: 
  - 合并相似查询（如 "Bay Area food" 和 "Bay Area restaurant"）
  - 使用更通用的查询覆盖多个城市和类别
  - 减少重复查询
- **效果**: 减少 66% 的查询数量（从 15 个减少到 5 个）

### 4. 错误处理改进 ⚠️
- **之前**: 返回模拟数据，可能误导系统
- **现在**: 
  - 检测到配额错误时返回空结果并设置标志
  - 所有搜索函数在执行前检查配额状态
  - 分页查询时每页都检查配额
- **效果**: 更准确的错误处理和资源保护

### 5. 查询去重 🔄
- **机制**: 
  - 通过 Redis 缓存自动去重
  - 24 小时缓存确保相同查询不会重复调用 API
- **效果**: 避免重复查询相同内容

## 代码变更

### `api/app/services/google_search.py`
- 新增 `check_quota_exceeded()` 函数
- 修改 `search_google()` 函数：
  - 添加配额检查
  - 增加缓存时间
  - 改进错误处理（检测 429 错误并设置标志）
- 修改 `fetch_multiple_pages()` 函数：
  - 添加配额检查
  - 每页查询前检查配额

### `api/app/scheduler.py`
- 修改 `process_search_query()` 函数：
  - 添加配额检查
- 修改 `run_coupon_search()` 函数：
  - 减少查询数量（从 15 个减少到 5 个）
  - 添加配额检查
  - 优化查询内容

## 使用建议

### 监控配额使用
运行测试脚本检查配额状态：
```bash
docker compose exec api python test_quota_check.py
```

### 手动清除配额标志
如果配额已重置但标志仍在，可以手动清除：
```bash
docker compose exec api python -c "import redis; r = redis.from_url('redis://localhost:6379/0', decode_responses=True); r.delete('google_cse:quota_exceeded'); print('Quota flag cleared')"
```

### 预期效果
- **API 调用减少**: 约 70-80% 的调用会被缓存拦截
- **配额使用**: 每天使用量从 ~100 次减少到 ~20-30 次
- **错误处理**: 配额用完后自动停止调用，避免浪费

## 注意事项

1. **缓存时间**: 24 小时缓存意味着新内容可能需要最多 24 小时才能显示
2. **配额重置**: Google CSE 配额每天重置（太平洋时间午夜）
3. **Redis 依赖**: 配额检查和缓存都依赖 Redis，确保 Redis 正常运行

## 未来优化方向

1. **智能缓存**: 根据查询类型动态调整缓存时间
2. **配额预测**: 跟踪每日使用量，提前预警
3. **查询优先级**: 优先处理重要查询，配额不足时跳过次要查询
4. **多 API 密钥**: 使用多个 API 密钥轮换（如果可用）

